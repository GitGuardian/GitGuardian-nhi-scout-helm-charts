---
# Test docs: https://github.com/helm-unittest/helm-unittest/blob/main/DOCUMENT.md
suite: test cronjob
values:
- ../test_values.yaml
templates:
- cronjob.yaml
tests:
- it: should work
  set:
    inventory.version: latest
  asserts:
  - isKind:
      of: CronJob
  - matchRegex:
      path: metadata.name
      pattern: -nhi-explorer$
  - equal:
      path: spec.jobTemplate.spec.template.spec.containers[0].image
      value: ghcr.io/gitguardian/gg-nhi-explorer:latest

- it: should set schedule
  set:
    inventory.schedule: 1 * * * *
  asserts:
  - equal:
      path: spec.schedule
      value: 1 * * * *

- it: should set image pull secrets
  set:
    imagePullSecrets:
    - name: foobar
  asserts:
  - equal:
      path: spec.jobTemplate.spec.template.spec.imagePullSecrets
      value:
      - name: foobar

- it: should set resources
  set:
    resources:
      limits:
        cpu: 200m
        memory: 200m
      requests:
        cpu: 100m
        memory: 100m
  asserts:
  - equal:
      path: spec.jobTemplate.spec.template.spec.containers[0].resources.limits
      value:
        cpu: 200m
        memory: 200m
  - equal:
      path: spec.jobTemplate.spec.template.spec.containers[0].resources.requests
      value:
        cpu: 100m
        memory: 100m

- it: should set configmap mounts
  asserts:
  - contains:
      path: spec.jobTemplate.spec.template.spec.containers[0].volumeMounts
      content:
        name: config
        mountPath: /etc/inventory
  - contains:
      path: spec.jobTemplate.spec.template.spec.volumes
      content:
        name: config
        configMap:
          name: RELEASE-NAME-nhi-explorer
  - contains:
      path: spec.jobTemplate.spec.template.spec.containers[0].env
      content:
        name: INVENTORY_CONFIG_PATH
        value: /etc/inventory/config.yml

- it: should set env and envFrom
  set:
    envFrom:
    - secretRef:
        name: my-secret
    env:
    - name: foo
      value: bar
  asserts:
  - contains:
      path: spec.jobTemplate.spec.template.spec.containers[0].envFrom
      content:
        secretRef:
          name: my-secret
  - contains:
      path: spec.jobTemplate.spec.template.spec.containers[0].env
      content:
        name: foo
        value: bar
